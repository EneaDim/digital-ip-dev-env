# Digital IP design environment 

This repository provides an environment designed to simplify the development and integration of digital IPs into a System-on-Chip (SoC). It supports various stages of digital IP development, including configuration initialization, documentation generation, CSR register generation, linting, functional simulation for design verification, synthesis trials, static timing analysis, and power estimation, fetching of other IPs from github, xbar generation and SoC integration. All using open-source tools.

The primary objective of this project is to assist digital designers in developing their own IPs while making open-source EDA tools more accessible and easy to use.

Additionally, the environment serves as a user-friendly platform for digital IP development, aligned with the IP development process defined by lowRISC. Once the initial development phase is complete, the IPs can seamlessly transition into the lowRISC integration flow for SoC inclusion.

Furthermore, a simple SoC can be assembled using components such as the Ibex core, RAM primitives, a UART, and either custom-developed IPs or externally sourced ones. All components are integrated using a TileLink UL (TLUL) bus interconnect.

## Table of Contents

- [Flow Overview](#flow-overview)
- [Folder Structure](#folder-structure)
- [Dependecies](#dependecies)
- [Usage](#usage)
- [Tutorial\_1](#tutorial-1)
- [Tutorial\_2](#tutorial-2)
- [Environment Details](#environment-details)
- [Next Steps](#next-step)
- [License](#license)

## Flow Overview

- CSR definition
- RTL development
- Linting
- Testbench based simulation
- Regression definition
- Synthesis trials
- Static Timing Analysis
- Power Analysis
- SoC integration
- SW drivers definition
- SoC simulation

## Folder Structure

- `scripts`: Python scripts to setup the environment and facilitate the steps of designing digital IPs and integrate them into an SoC. 
- `util`: lowRISC utility scripts to build documentation, regmap and use vendor functionality to fetch other repositories from github.
- `fsm_gen`: Environment to generate SystemVerilog RTL FSMs from `.txt` and `.csv` files. The `.txt` file describes the state transitions and the `.csv` file describe the outputs for each state. It supports only Moore FSMs.
- `lib`: SKY130 `.lib` files for each corner. (IHP130 to be added)
- `verilog`: Verilog models of SKY130 standard cells primitives for post-syn simulation.
- `ips`: ips collection, packages and primitives.
- `vendor`: hjson files for fetching lowrisc\_ip and lowrisc\_ibex, and patch files.
- `sw`: software for driving the ibex core in a SoC.


### Folder generated by the SETUP step

- `data`: `.hjson` file describing the IPs. This file is also used to generate documentation and register map.
- `doc`: IP documentation.
- `model`: SystemVerilog models of other IPs of the system (ADC, DAC, Memory, ...).
- `log`: Log of the output of each step.
- `rtl`: RTL files describing the IP submodules.
- `lint`: lint waivers.
- `tb`: Testbenches created to perform design verification of the IP.
- `tb/regression`: Testbenches defined to be part of the regression.
- `sim`: `.vcd`, `.gtkw` and verilator files used to simulate and view the waveforms of the simulations.
- `syn`: Synthesis flow results.
- `signoff`: Static Timing Analysis and Power Analysis flow results.

## Dependecies

The commands to install the dependecies are provided in the `dependencies.sh` file. Running this script will automate the installation process. The Open Source Tools used are:

- `sv2v`: SystemVerilog file list to single Verilog file converter.
- `verilator`: RTL compiler and simulator. Used mainly for linting step. But it can be used also as compiler and simulator.
- `iverilog`: Compiler and Simulator of RTL code.
- `gtkwave`: Waveform viewer.
- `yosys`: Synthesis tool.
- `OpenSTA`: Static Timing Analysis and Power Analysis tool.
- `RISCV GNU Toolchain`: For SoC simulation with IBEX as host

The python dependecies can be installed running `pip install -r python-requirements.txt` on your system or on a virtual environment.

## Usage

1. Run `make help` to see the guide for the steps of digital IP development and SoC integration.
2. Run `make help_doc` to see the guide for generating the documentation.
3. Run `make help_fsm` to see the guide for generating FSMs.

## Tutorial\_1 - Basic FSM
- `make fsm_tutorial TOP=fsm_example`
1. Runs setup
2. Copies example input files
3. Generates the FSM
4. Plots the FSM diagram
5. Copies generated `.sv` files to `rtl/`
6. Sets up testbench
7. Generate HJSON configurations 
8. Generate documentation
9. Run lint checks
10. Compile
11. Simulate RTL
12. View pre-synthesis
13. Run synthesis
14. Backannotate SDF
15. Perform static timing analysis (STA)
16. Report STA violations
17. Estimate power

## Tutorial\_2 - SoC flow

- `make full_flow`

Runs the complete top-level SoC integration and build process. This is the recommended end-to-end target for preparing and simulating the SoC.
The IP used is a custom and simple SPI\_HOST.
Steps performed:
1. **Load custom SPI_HOST IP:**  
   `make load_ip`
2. **Fetch LowRISC IPs:**  
   `make fetch VENDOR=lowrisc_ip`
3. **Fetch Ibex core:**  
   `make fetch VENDOR=lowrisc_ibex`
4. **Generate XBAR interconnect:**  
   `make xbar`
5. **Run the full SoC development flow:**  
   `make soc_flow`

Then:

- `make soc_view`

View the waveforms. Inside TOP/top\_verilator, select u\_soc, and plot spi\_cs\_o, spi\_sclk\_o, spi\_sdio\_o. 
You should see 2 drivings.

## Environment Details

### Configuration description (`config.mk`): 

#### Python interpreter version
- `PYTHON` : This line sets the Python interpreter to be used in the project. If not specified, it defaults to `python3`.

#### Project and Top Module Names

- `PRJ`: The name of the project, defaulting to `fpga_board`.
- `TOP`: The name of the top module in the design, defaulting to `top`.

#### Directory Structure

- `RTLDIR`: Directory for RTL (Register Transfer Level) files.
- `TBDIR`: Directory for testbench files.
- `LINTDIR`: Directory for lint waiver files.
- `REGRESSIONDIR`: Directory for testbench files ussed for regression.
- `SIMDIR`: Directory for simulation files.
- `SYNDIR`: Directory for synthesis files.
- `SIGNOFFDIR`: Directory for sign-off files.
- `MODELDIR`: Directory for model files.
- `LOGDIR`: Directory for log files.
- `DOCDIR`: Directory for documentation.
- `DATADIR`: Directory for data files.
- `VENDORDIR`: Directory for vendor hjson files and patches.
- `UTILDIR`: Directory for utility scripts.
- `SCRIPTSDIR`: Directory for additional scripts.

#### Compile Tools

- `SV2V`: Tool for converting SystemVerilog to Verilog.
- `LINTER`: Tool for linting the code, default is `verilator`.
- `COMPILER`: Tool for compiling the Verilog code, default is `verilator`.
              For SoC integration only `verilator`is supported.
              `iverilog` can be used for the core features of the IP, without the gerister interface.

#### Linting Configuration

- `LINT_FLAGS` : This variable defines the flags used for linting the code. It includes:
    - `-Wall`: Enable all warnings.
    - `-Wno-fatal`: Do not treat warnings as errors.
    - `--lint-only`: Only perform linting without compiling.
    - `--top-module $(TOP)`: Specify the top module for linting.

#### Simulation Configuration

- `TESTBENCHES` : This variable automatically collects all SystemVerilog testbench files from the specified testbench directory.

#### Waveform Viewer Configuration

- `VIEWER`: The waveform viewer to be used, defaulting to `gtkwave`.
- `VIEWER_FLAGS`: Flags for configuring the waveform viewer's appearance.
- `VIEWER_CONF`: Configuration file for the waveform viewer (`.gtkw` file).

#### Synthesis and Sign-off Configuration

- `YOSYS`: Tool for synthesis.
- `STA`: Static Timing Analysis tool.
- `CLK_PERIOD`: Clock period, defaulting to 10 time units (ns).
- `TARGET_SYN`: Target technology, defaulting to `asic`.
- `ACTIVITY`: Activity factor for Static Power Analysis, defaulting to 10 (10%).
- `MODULE`: The module name, defaulting to the top module.
- `PATH_VIEW _FILE`: File for viewing path violations, defaulting to the top module's static timing analysis results.
- `NPATHS`: Number of paths to analyze, defaulting to 20.

#### SKY130 Libraries

- `LIBS`: A list of library files for the SKY130 technology. These libraries include:
    - `sky130_fd_sc_hd__ss_100C_1v40.lib`: Fast-slow corner library at 100째C and 1.4V.
    - `sky130_fd_sc_hd__tt_025C_1v80.lib`: Typical-typical corner library at 25째C and 1.8V.
    - `sky130_fd_sc_hd__ff_n40C_1v95.lib`: Fast-fast corner library at -40째C and 1.95V.
- `LIB_SYN`: The library file used for synthesis, defaulting to the typical-typical corner library at 25째C and 1.8V.
- `PRIM`: A list of Verilog primitive files used in the design. This includes:
    - `primitives.v`: Standard Verilog primitives.
    - `sky130_fd_sc_hd.v`: SKY130 specific primitives.

#### SoC Integration

- `VENDOR`: Vendor target to be fetched through hjson file

- `FUSESOC`: The tool used for managing and building hardware designs, specifically for the project.

- `SOC_MEMORY_MAP`: device memory map for SoC integration

#### Shell Functions

- `ECHO`: Command for printing text to the terminal.
- `MKDIR`: Command for creating directories.
- `GREP`: Command for searching text using patterns.
- `CP`: Command for copying files.
- `RM`: Command for removing files and directories.
- `FIND`: Command for searching for files in a directory hierarchy.
- `CLEAR`: Command for clearing the terminal screen.

#### Color Codes

- `ORANGE`: Color code for orange text.
- `RED`: Color code for red text.
- `GREEN`: Color code for green text.
- `YELLOW`: Color code for yellow text.
- `BLUE`: Color code for blue text.
- `RESET`: Resets the text color to default.


### Flow description (`Makefile`): 

#### Help target

- `help`

Run a Python script to display help information about the Makefile targets.

- `help_doc`

Run a Python script to display help informations regarding the documentation generation.

- `help_fsm`

Run a Python script to display informations on how to generate systemverilog FSMs from configuration files.

#### Setup Folder Structure

- `setup`

Create the necessary directory structure for the project, including directories for logs, RTL files, testbenches, simulations, synthesis, sign-off, models, utilities, documentation, and data.

#### HJSON Template Generation

- `hjson`

Generate an HJSON template file using a Python script, specifying the top module and output directory.

#### SystemVerilog Register Generator

- `reg`

Generate a register map from the HJSON description.

#### Markdown Generator

- `doc`

Generate Markdown files from the HJSON description using a utility script.

#### Fetch vendor repo

- `fetch`

Fetch the repo defined in the hjson file under vendor folder.
Usage: make fetch VENDOR=lowrisc\_ip

#### SystemVerilog2Verilog

- `sv2v`

Perform the conversion of multiple systemverilog files into a single verilog file.

#### Linting

- `lint`

Perform linting on the generated Verilog file and logs the output.

- `lint_sv`

Perform linting on the top SystemVerilog file of the IP, you can add depencedies files as "LINT\_FILES=submodule1.sv submodule2.sv ...".
Suitable for little number of dependecies.

#### Setup testbench

- `setup_tb`

Generate the systemverilog testbench template.

#### Compilation Targets

- `compile`

Compile the testbench that includes all the RTL files, depending on the specified compiler.

#### Simulation Targets

- `sim`

Simulate the testbench after compilation, again depending on the specified compiler.

#### Viewing Waveforms

- `view`
Open the waveform viewer to visualize the simulation results.

#### Cocotb Integration

- `cocotb`

Run the Cocotb testbench located in the testbench directory.

#### Regression Testing

- `regression`

Run a Python script to perform regression testing on the design.

#### Synthesis Targets

- `syn`

Run synthesis using Yosys and logs the output, including any warnings or errors.

- `compile_syn`

Compile the post-synthesis netlist for simulation.

- `sim_syn`

Simulate the post-synthesis netlist.

#### Static Timing Analysis (STA)

- `sta`

Perform static timing analysis and logs the results, including any warnings or errors.

#### Power Analysis

- `power`

Perform power analysis, both static and dynamic, and logs the results.

#### Path View Generation

- `path_view`

Generate a path view of the STA report.

#### SDF File Generation

- `sdf`

Generate SDF files for timing information.

#### Testbench Management

- `save_tb`

Save the current testbench file for future reference.

#### IP management

- `save_ip`

Save all files related to the ip developed under ips/ folder.

- `load_ip`

Load back in the environment the ip under ips/ folder.

#### FSM generator

- `fsm_gen`

Generate `.sv` and `.gv` files of the FSM described with `.txt` and `.csv` files under the folder `fsm_gen/inputs/`.

- `fsm_plot`

Plot the `.gv` file generated by the previous step.

#### SoC Integration

- `fsoc_init`

Initializes FuseSoC core file for the ip.

- `fsoc`

Run fusesoc.
Usage: make fsoc TARGET=lint

- `xbar_init`

Initialize the the XBAR hjson file assuming IBEX as host.

- `xbar_build`

Build the XBAR systemverilog file using tlgen.py

- `xbar`

Run xbar\_init && xbar\_build.

- `soc_build`

Generate the top-level SoC SystemVerilog file using `soc_gen.py` with `uart` as a module.  

- `soc_sim`

Sets up and builds the SoC simulation environment using **FuseSoC** with **Verilator**.  

- `soc_run`

Compile the `hello_world.c` using **GCC** and runs the Verilator simulation.  

- `soc_view`

Open the simulation waveform (`sim.fst`) using the waveform viewer.  

- `soc_flow`

Run the complete SoC development flow: build, simulate, and execute.  
Equivalent to running: `make soc_build soc_sim soc_run`.

#### Basic Flow

- `flow_all`

Run the complete flow, including linting, simulation, synthesis, static timing analysis, and power analysis.

- `flow`

Run a subset of the flow, excluding power analysis and simulation of the synthesized netlist.

#### Cleaning Targets

- `clean_fsm`

Clean up files generated fsm\_gen step.

- `clean_log`

Clean up log files generated during the build process.

- `clean_rtl`

Remove generated RTL files.

- `clean_sim`

Remove simulation files, including VVP and VCD files.

- `clean_syn`

Clean up synthesis output files.

- `clean_signoff`

Remove sign-off related files.

- `clean_subdir`

Clean up subdirectories related to the FSM generator.

- `clean`

Perform a comprehensive clean-up of all generated files and directories.

- `clean_all`

Remove all project directories and files, effectively resetting the project.

## Next Steps

- Align with dvsim flow of lowRISC
- HJSON parametric template generation
- Support other register interface like AXI-Lite
- Better support for cocotb dv flow
- Extend SW stack to automatically generate drivers for new IPs.
- Better alignment to lowRISC flow to easisy export the result of this IP develpment flow.

## License

Unless otherwise noted, everything in the repository is covered by the [Apache License](https://www.apache.org/licenses/LICENSE-2.0.html), Version 2.0.
