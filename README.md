# Digital IP design environment 

This repository setup an environment to easily design digital IPs and integrate them in a SoC. This environment helps in different phases of designing digital IPs including: documentation building, design verification with functional simulations, synthesys trials, static timing analysis and power analysis using Open Source Tools.

The main goal of this project is to help digital designers to develop their own IPs and use Open Source EDA tools in a simple way.

It also aims to be an "easy to use" early stage digital IP development environment compatible with IP development process defined by lowRISC. After this early stage development phase the IP should easily follow the lowRISC flow for IP integration into an SoC.



## Table of Contents

- [Folder Structure](#folder-structure)
- [Dependecies](#dependecies)
- [Getting Started](#getting-started)
- [Usage](#usage)
- [Tutorial](#tutorial)
- [Next Steps](#next-step)
- [License](#license)

## Folder Structure

- `scripts`: Python scripts to setup the environment and facilitate the steps of designing digital IPs and integrate them into an SoC. 
- `util`: lowRISC utility scripts to build documentation and regmap. (To be updated using vendor functionality from lowRISC)
- `fsm_gen`: Environment to generate SystemVerilog RTL FSMs from `.txt` and `.csv` files. The `.txt` file describes the state transitions and the `.csv` file describe the outputs for each state. It supports only Moore FSMs.
- `lib`: SKY130 `.lib` files for each corner. (IHP130 to be added)
- `verilog`: Verilog models of SKY130 standard cells primitives for post-syn simulation.

### Folder generated by the SETUP step

- `data`: `.hjson` file describing the IPs. This file is also used to generate documentation and register map.
- `doc`: IP documentation.
- `model`: SystemVerilog models of other IPs of the system (ADC, DAC, Memory, ...).
- `log`: Log of the output of each step.
- `rtl`: RTL files describing the IP submodules.
- `tb`: Testbenches created to perform design verification of the IP.
- `tb/regression`: Testbenches defined to be part of the regression.
- `sim`: `.vcd` and `.gtkw` file used to view the waveforms of the simulations.
- `syn`: Synthesis flow results.
- `signoff`: Static Timing Analysis and Power Analysis flow results.

## Dependecies

The commands to install the dependecies are provided in the `dependencies.sh` file. Running this script will automate the installation process. The Open Source Tools used are:

- `sv2v`: SystemVerilog file list to single Verilog file converter.
- `verilator`: RTL compiler and simulator. Used mainly for linting step. But it can be used also as compiler and simulator.
- `iverilog`: Compiler and Simulator of RTL code.
- `gtkwave`: Waveform viewer.
- `yosys`: Synthesis tool.
- `OpenSTA`: Static Timing Analysis and Power Analysis tool.

The python dependecies can be installed running `pip install -r python-requirements.txt`.

## Getting Started

### Configuration description (`config.mk`): 

#### Python interpreter version
- `PYTHON` : This line sets the Python interpreter to be used in the project. If not specified, it defaults to `python3`.

#### Project and Top Module Names

- `PRJ`: The name of the project, defaulting to `fpga_board`.
- `TOP`: The name of the top module in the design, defaulting to `top`.

#### Directory Structure

- `RTLDIR`: Directory for RTL (Register Transfer Level) files.
- `TBDIR`: Directory for testbench files.
- `REGRESSIONDIR`: Directory for testbench files ussed for regression.
- `SIMDIR`: Directory for simulation files.
- `SYNDIR`: Directory for synthesis files.
- `SIGNOFFDIR`: Directory for sign-off files.
- `MODELDIR`: Directory for model files.
- `LOGDIR`: Directory for log files.
- `DOCDIR`: Directory for documentation.
- `DATADIR`: Directory for data files.
- `UTILDIR`: Directory for utility scripts.
- `SCRIPTSDIR`: Directory for additional scripts.

#### Compile Tools

- `SV2V`: Tool for converting SystemVerilog to Verilog.
- `LINTER`: Tool for linting the code, defaulting to `verilator`.
- `COMPILER`: Tool for compiling the Verilog code, defaulting to `iverilog`.

#### Linting Configuration

- `LINT_FLAGS` : This variable defines the flags used for linting the code. It includes:
    - `-Wall`: Enable all warnings.
    - `-Wno-fatal`: Do not treat warnings as errors.
    - `--lint-only`: Only perform linting without compiling.
    - `--top-module $(TOP)`: Specify the top module for linting.

#### Simulation Configuration

- `TESTBENCHES` : This variable automatically collects all SystemVerilog testbench files from the specified testbench directory.

#### Waveform Viewer Configuration

- `VIEWER`: The waveform viewer to be used, defaulting to `gtkwave`.
- `VIEWER_FLAGS`: Flags for configuring the waveform viewer's appearance.
- `VIEWER_CONF`: Configuration file for the waveform viewer (`.gtkw` file).

#### Synthesis and Sign-off Configuration

- `YOSYS`: Tool for synthesis.
- `STA`: Static Timing Analysis tool.
- `CLK_PERIOD`: Clock period, defaulting to 10 time units (ns).
- `TARGET`: Target technology, defaulting to `asic`.
- `ACTIVITY`: Activity factor for Static Power Analysis, defaulting to 10 (10%).
- `MODULE`: The module name, defaulting to the top module.
- `PATH_VIEW _FILE`: File for viewing path violations, defaulting to the top module's static timing analysis results.
- `NPATHS`: Number of paths to analyze, defaulting to 20.

#### SKY130 Libraries

- `LIBS`: A list of library files for the SKY130 technology. These libraries include:
    - `sky130_fd_sc_hd__ss_100C_1v40.lib`: Fast-slow corner library at 100째C and 1.4V.
    - `sky130_fd_sc_hd__tt_025C_1v80.lib`: Typical-typical corner library at 25째C and 1.8V.
    - `sky130_fd_sc_hd__ff_n40C_1v95.lib`: Fast-fast corner library at -40째C and 1.95V.
- `LIB_SYN`: The library file used for synthesis, defaulting to the typical-typical corner library at 25째C and 1.8V.
- `PRIM`: A list of Verilog primitive files used in the design. This includes:
    - `primitives.v`: Standard Verilog primitives.
    - `sky130_fd_sc_hd.v`: SKY130 specific primitives.

#### Shell Functions

- `ECHO`: Command for printing text to the terminal.
- `MKDIR`: Command for creating directories.
- `GREP`: Command for searching text using patterns.
- `CP`: Command for copying files.
- `RM`: Command for removing files and directories.
- `FIND`: Command for searching for files in a directory hierarchy.
- `CLEAR`: Command for clearing the terminal screen.

#### Color Codes

- `ORANGE`: Color code for orange text.
- `RED`: Color code for red text.
- `GREEN`: Color code for green text.
- `YELLOW`: Color code for yellow text.
- `BLUE`: Color code for blue text.
- `RESET`: Resets the text color to default.

#### Fusesoc

- `FUSESOC`: The tool used for managing and building hardware designs, specifically for the project.

### Flow description (`Makefile`): 

#### Help target

- `help`
This target runs a Python script to display help information about the Makefile targets.

- `help_doc`
This target runs a Python script to display help informations regarding the documentation generation.

- `help_fsm`
This target runs a Python script to display informations on how to generate systemverilog FSMs from configuration files.

#### Setup Folder Structure

- `setup`
This target creates the necessary directory structure for the project, including directories for logs, RTL files, testbenches, simulations, synthesis, sign-off, models, utilities, documentation, and data.

#### HJSON Template Generation

- `hjson`
This target generates an HJSON template file using a Python script, specifying the top module and output directory.

#### Markdown Generator

- `md`
This target generates Markdown files from the HJSON description using a utility script.

#### SystemVerilog2Verilog

- `sv2v`
This target performs the conversion of multiple systemverilog files into a single verilog file.

#### Linting

- `lint`
This target performs linting on the generated Verilog file and logs the output.

- `lint_sv`
This target performs linting on the top SystemVerilog file of the IP, you can add depencedies files as "LINT\_FILES=submodule1.sv submodule2.sv ...".

#### Setup testbench

- `setup_tb`
This target generate the systemverilog testbench template.

#### Compilation Targets

- `compile`
This target compiles the testbench that includes all the RTL files, depending on the specified compiler.

#### Simulation Targets

- `sim`
This target simulates the testbench after compilation, again depending on the specified compiler.

#### Viewing Waveforms

- `view`
This target opens the waveform viewer to visualize the simulation results.

#### Cocotb Integration

- `cocotb`
This target runs the Cocotb testbench located in the testbench directory.

#### Regression Testing

- `regression`
This target runs a Python script to perform regression testing on the design.

#### Synthesis Targets

- `syn`
This target runs synthesis using Yosys and logs the output, including any warnings or errors.

- `compile_syn`
This target compiles the post-synthesis netlist for simulation.

- `sim_syn`
This target simulates the post-synthesis netlist.

#### Static Timing Analysis (STA)

- `sta`
This target performs static timing analysis and logs the results, including any warnings or errors.

#### Power Analysis

- `power`
This target performs power analysis, both static and dynamic, and logs the results.

#### Path View Generation

- `path_view`
This target generates a path view of the STA report.

#### SDF File Generation

- `sdf`
This target generates SDF files for timing information.

#### Testbench Management

- `save_tb`
This target saves the current testbench file for future reference.

#### SystemVerilog Register Generator

- `reg`
This target generates a register map from the HJSON description, with a note that compilation is not yet supported.

#### Basic Flow

- `flow_all`
This target runs the complete flow, including linting, simulation, synthesis, static timing analysis, and power analysis.

- `flow`
This target runs a subset of the flow, excluding power analysis and simulation of the synthesized netlist.

#### FSM generator

- `fsm_gen`
This target generate `.sv` and `.gv` files of the FSM described with `.txt` and `.csv` files under the folder `fsm_gen/inputs/`.

- `fsm_plot`
This target plots the `.gv` file generated by the previous step.

#### Cleaning Targets

- `fsm_clean`
This target cleans up files generated fsm\_gen step.

- `clean_log`
This target cleans up log files generated during the build process.

- `clean_rtl`
This target removes generated RTL files.

- `clean_sim`
This target removes simulation files, including VVP and VCD files.

- `clean_syn`
This target cleans up synthesis output files.

- `clean_signoff`
This target removes sign-off related files.

- `clean_subdir`
This target cleans up subdirectories related to the FSM generator.

- `clean`
This target performs a comprehensive clean-up of all generated files and directories.

- `clean_all`
This target removes all project directories and files, effectively resetting the project.

## Usage

1. Run `make help` to see the guide for the steps of digital IP development in this environment.
2. Run `make help_doc` to see the guide for generating the documentation.
3. Run `make help_fsm` to see the guide for generating FSMs.

## Tutorial

1. `make clean_all` : clean the environment.
2. `make setup` : setup the environment.
3. `cp fsm_gen/examples/* fsm_gen/inputs/` : copy example files of FSM description to fsm\_gen/input/ folder
4. `make fsm_gen` : generate FSM.
5. `make fsm_plot` : plot FSM.
6. `cp fsm_gen/outputs/*.sv rtl` : copy the result under rtl/ folder
7. `make setup_tb` : generate the testbench. 
8. `make sim view` : compile, simulate and view.
9. `make view_presyn` : view yosys presyn.
10. `make syn sta power` : run synthesis, static timing analysis and power analysis.

## Next Steps

- Better alignment to lowRISC flow to easisy export the result of this early IP develpment stage flow.
- Enable `fusesoc` flow setup and run to handle dependecies.
- `.core` file template generation.
- HJSON parametric template generation
- Support other register interface like AXI-Lite
- Align with dvsim flow of lowRISC
- Automatically generate basic read write transaction when working with the top and tlul interface.
- Better support for cocotb dv flow

## License

Unless otherwise noted, everything in the repository is covered by the [Apache License](https://www.apache.org/licenses/LICENSE-2.0.html), Version 2.0.
